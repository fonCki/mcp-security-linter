const BaseAnalyzer = require('./base-analyzer');
const path = require('path');

const AI_PATTERNS = [
  /\bchatgpt\b/gi,
  /\bopenai\b/gi,
  /\bclaude\b/gi,
  /\banthrophic\b/gi,
  /\bgpt-[34]\b/gi,
  /\bgenerated by ai\b/gi,
  /\bcopilot\b/gi,
  /\bgemini\b/gi,
  /\bbard\b/gi
];

class AIDetector extends BaseAnalyzer {
  constructor(options = {}) {
    super('ai-detector', options);
    this.patterns = options.customPatterns ?
      [...AI_PATTERNS, ...options.customPatterns] :
      AI_PATTERNS;
    this.extensions = options.extensions || ['.js', '.ts', '.jsx', '.tsx', '.py', '.java'];
  }

  analyze(filePath, content) {
    const findings = [];

    if (!this.shouldAnalyze(filePath)) {
      return findings;
    }

    this.patterns.forEach((pattern) => {
      const matches = content.matchAll(pattern);
      for (const match of matches) {
        const lines = content.substring(0, match.index).split('\n');
        const line = lines.length;
        const column = lines[lines.length - 1].length + 1;

        findings.push(this.createFinding(
          filePath,
          line,
          column,
          `Potential AI-generated content detected: "${match[0]}"`,
          'ai-generated-content'
        ));
      }
    });

    return findings;
  }

  shouldAnalyze(filePath) {
    const ext = path.extname(filePath);

    // Skip test files
    if (filePath.includes('.test.') || filePath.includes('.spec.') || filePath.includes('__tests__')) {
      return false;
    }

    return this.extensions.includes(ext);
  }
}

module.exports = AIDetector;